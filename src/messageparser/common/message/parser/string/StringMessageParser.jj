 /**
 * JavaCC file for StringMessageParser
 *
 * @author Arwid Bancewicz
 */options{ /* JDK_VERSION = "1.4"; */}PARSER_BEGIN(StringMessageParser)package messageparser.common.message.parser.string;import java.util.HashMap;import java.io.Serializable;import java.util.Collections;import java.util.HashMap;import java.util.Map;import java.util.Date;import messageparser.common.message.parser.UniversalMessageParser;import messageparser.common.message.Predicate;import messageparser.common.message.Advertisement;import messageparser.common.message.Subscription;import messageparser.common.message.Publication;import messageparser.common.message.CompositeSubscription;import messageparser.common.message.CompositeSubscriptionOPs;import messageparser.common.message.CompositeNode;import messageparser.common.message.Unadvertisement;import messageparser.common.message.Unsubscription;import messageparser.common.message.Uncompositesubscription;public class StringMessageParser extends UniversalMessageParser{  public StringMessageParser()  {}  private StringMessageParser getParser(String stringRep)  {    java.io.StringReader sr = new java.io.StringReader(stringRep);    java.io.Reader r = new java.io.BufferedReader(sr);    StringMessageParser parser = new StringMessageParser(r);    return parser;  }  //  public Object parse(String stringRep) throws ParseException  //  {  //    Object o = getParser(stringRep).input();  //    return o;  //  }
  public Publication parsePublication(String stringRep) throws ParseException  {    Publication o = getParser(stringRep).publication();    return o;  }  public Advertisement parseAdvertisement(String stringRep) throws ParseException  {    Advertisement o = getParser(stringRep).advertisement();    return o;  }  public Subscription parseSubscription(String stringRep) throws ParseException  {    Subscription o = getParser(stringRep).subscription();    return o;  }  public CompositeSubscription parseCompositeSubscription(String stringRep) throws ParseException  {    CompositeSubscription o = getParser(stringRep).compositeSubscription();    return o;  }  public Map < String, Serializable > parsePairMap(String stringRep) throws ParseException  {    Map < String, Serializable > o = getParser(stringRep).pairMap();    return o;  }  public Map < String, Predicate > parsePredicateMap(String stringRep) throws ParseException  {    Map < String, Predicate > o = getParser(stringRep).predicateMap();    return o;  }  public String printPairMap(Map < String, Serializable > pairMap)  {    String stringRep = "";    stringRep += "[class," + pairMap.get("class") + "]";    synchronized (pairMap)    {      for (String attribute : pairMap.keySet())      {        if (attribute == null) break;        if (attribute.equalsIgnoreCase("class")) continue;        Object value = pairMap.get(attribute);        stringRep += ",[\"" + attribute + "\",";        if ((value.getClass()).equals(String.class) || (value.getClass()).equals(Date.class))        {          stringRep += "\"" + value + "\"";        }        else        {          stringRep += value;        }        stringRep += "]";      }    }    stringRep += "";    return stringRep;  }  public String printPredicateMap(Map < String, Predicate > predicateMap)  {    String stringRep = "";    stringRep += "[class,eq,\"" + predicateMap.get("class").getValue() + "\"]";    synchronized (predicateMap)    {      for (String attribute : predicateMap.keySet())      {        if (attribute.equalsIgnoreCase("class")) continue;        Predicate p = predicateMap.get(attribute);        stringRep += ",[" + attribute + "," + p.getOp() + ",";        if ((p.getValue().getClass()).equals(String.class) || (p.getValue().getClass()).equals(Date.class))        {          stringRep += "\"" + p.getValue() + "\"";        }        else        {          stringRep += p.getValue();        }        stringRep += "]";      }    }    stringRep += "";    return stringRep;  }  public String printCompositeSubscription(CompositeSubscription cs)  {    // Not complete
    return printCompositeNodes(cs.getRoot(), cs.getSubscriptionMap());  }  public String printCompositeNodes(CompositeNode root, Map < String, Subscription > subMap)  {    String rootToString = "";    if (root.content.equals(CompositeSubscriptionOPs.COMPOSIT_SUBSCRIPTION_AND) || root.content.equals(CompositeSubscriptionOPs.COMPOSIT_SUBSCRIPTION_OR))    {      rootToString = "{" + printCompositeNodes(root.leftNode, subMap) + " " + root.content + " " + printCompositeNodes(root.rightNode, subMap) + "}";    }    else    {      Subscription sub = subMap.get(root.content);      rootToString = "{" + printPredicateMap(sub.getPredicateMap()) + "}";    }    return rootToString;  }  public String print(Object obj)  {    return print(obj, false);  }  public String print(Object obj, Boolean withTag)  {    String ret = "";    ret += "";    if (obj instanceof Publication)    {      if (withTag) ret += "p ";      Publication pub = (Publication) obj;      ret += printPairMap(pub.getPairMap());      ret += ";" + pub.getTimeStamp() + "";    }    else if (obj instanceof Advertisement)    {      if (withTag) ret += "a ";      Advertisement adv = (Advertisement) obj;      ret += printPredicateMap(adv.getPredicateMap());      ret += ";";      //ret += ",\"timestamp\":\""+pub.getTimeStamp()+"\"";
    }    else if (obj instanceof Subscription)    {      if (withTag) ret += "s ";      Subscription sub = (Subscription) obj;      ret += printPredicateMap(sub.getPredicateMap());      ret += ";";    }    else if (obj instanceof CompositeSubscription)    {      if (withTag) ret += "cs ";      CompositeSubscription sub = (CompositeSubscription) obj;      ret += printCompositeNodes(sub.getRoot(), sub.getSubscriptionMap());      //ret += ";";
    }    ret += "";    return ret;  }  /* Main method for testing */  public static void main(String args [])  {    StringMessageParser parser = new StringMessageParser();    while (true)    {      try      {        // String str = System.in
        //StringMessageParser parser = new StringMessageParser(System.in);
        java.io.BufferedReader r = new java.io.BufferedReader(new java.io.InputStreamReader(System.in));        String str = r.readLine();        Object o = parser.parse(str);        //Map < String, Serializable > o = parser.pairMap();
        //Map < String, Predicate > o = parser.terminatedPredicateMap();
        //sObject o = parser.input();
        //CompositeSubscription o = parser.compositeSubscription();
        // Publication o = parser.publication(); 
        System.err.println("JAVA OBJECT: " + o);      }      catch (Exception err)      {        err.printStackTrace();      }    }  }}PARSER_END(StringMessageParser)SKIP :{  " "| "\t"| "\n"| "\r"}TOKEN :{  < SOPERATOR :    "eq"  | "str-le"  | "str-lt"  | "str-gt"  | "str-ge"  | "str-prefix"  | "str-postfix"  | "str-contains"  | "neq" >| < NOPERATOR :    "="  | "<"  | ">"  | "<="  | ">="  | "<>" >| < LOPERATOR :    "&"  | "||" >| < COPERATOR : "isPresent" >}TOKEN :{  < #LETTER : [ "_", "a"-"z", "A"-"Z" ] >| < #DIGIT : [ "0"-"9" ] >| < #SIGN : [ "-", "+" ] >| < #EXPONENT :    (      "E"    | "e"    )    (< SIGN >)? (< DIGIT >)+ >| < FLOATING_NUMBER :    (< SIGN >)? (< DIGIT >)* "." (< DIGIT >)* (< EXPONENT >)?  | (< DIGIT >)+ (< EXPONENT >) >| < INT_NUMBER : (< SIGN >)? (< DIGIT >)+ >| < IDENTIFIER :    < LETTER >    (      < LETTER >    | < DIGIT >    | "-"    )* >| < #ESCAPE_CHAR : "\\" [ "n", "t", "b", "r", "f", "\\", "'", "\"" ] >| < SIMPLE_QUOTE_LITERAL :    "\'"    (      (~[ "\'", "\\", "\n", "\r" ])    | < ESCAPE_CHAR >    )+    "\'" >| < DOUBLE_QUOTE_LITERAL :    "\""    (      (~[ "\"", "\\", "\n", "\r" ])    | < ESCAPE_CHAR >    )+    "\"" >| < EMPTY_QUOTE_LITERAL :    "\'\'"  | "\"\"" >| < COMMA : "," >| < OPEN_CPAR : "{" >| < CLOSE_CPAR : "}" >| < OPEN_PAR : "[" >| < CLOSE_PAR : "]" >| < COLON : ":" >| < SEMI_COLON : ";" >}public Object input() :{  Object obj;}{  (    LOOKAHEAD(2)    obj = publication()  | LOOKAHEAD(2)    obj = advertisement()  | LOOKAHEAD(2)    obj = subscription()  | LOOKAHEAD(2)    obj = compositeSubscription()  )  {    return obj;  }}public Publication publication() :{  Map < String, Serializable > map;  Publication p = new Publication();  Token i;}{  (    i = < IDENTIFIER > map = terminatedPairMap()  )  {    if (!(i.toString().equals("p") || i.toString().equals("publish"))) throw new ParseException("Not a publication.");    p.setPairMap(map);    return p;  }}public Advertisement advertisement() :{  Map < String, Predicate > map;  Advertisement a = new Advertisement();  Token i;}{  (    i = < IDENTIFIER > map = terminatedPredicateMap()  )  {    if (!(i.toString().equals("a") || i.toString().equals("advertise"))) throw new ParseException("Not an advertisement.");    a.setPredicateMap(map);    return a;  }}public Subscription subscription() :{  Map < String, Predicate > map;  Subscription s = new Subscription();  Token i;}{  (    i = < IDENTIFIER > map = terminatedPredicateMap()  )  {    if (!(i.toString().equals("s") || i.toString().equals("subscribe"))) throw new ParseException("Not a subscription.");    s.setPredicateMap(map);    return s;  }}public String string() :{  Token t;}{  (    t = < SIMPLE_QUOTE_LITERAL >    {      return unescape(t.image);    }  | t = < DOUBLE_QUOTE_LITERAL >    {      return unescape(t.image);    }  | t = < IDENTIFIER >    {      return t.toString();    }  )}public Serializable number() :{  Token t;}{  (    t = < FLOATING_NUMBER >    {      return new Double(t.image);    }  | t = < INT_NUMBER >    {      return new Long(t.image);    }  )}public Serializable object() :{  Serializable o;}{  (    o = number()    {      return o;    }  | o = string()    {      return o;    }  )}public void keyValue(Map < String, Serializable > map) :{  Token i;  Serializable v;}{  (    < OPEN_PAR > i = < IDENTIFIER > < COMMA > v = object() < CLOSE_PAR >  )  {    map.put(i.image, v);  }}public Predicate predicate() :{  Token o;  Serializable v = "";}{  (    o = < SOPERATOR > < COMMA > v = string()    {      return new Predicate(o.toString(), v);    }  | o = < NOPERATOR > < COMMA > v = number()    {      return new Predicate(o.toString(), v);    }  | o = < COPERATOR > < COMMA >    (      v = string()    | v = number()    | < EMPTY_QUOTE_LITERAL >    )    {      return new Predicate(o.toString(), v);    }  )}public void keyPredicate(Map < String, Predicate > map) :{  Token k;  Predicate p;}{  (    < OPEN_PAR > k = < IDENTIFIER > < COMMA > p = predicate() < CLOSE_PAR >  )  {    map.put(k.image, p);  }}public Map < String, Serializable > pairMap() :{  Map < String, Serializable > map = Collections.synchronizedMap  (    new HashMap < String, Serializable > ()  )  ;}{  (    keyValue(map)    (      < COMMA > keyValue(map)    )*  )  {    return map;  }}public Map < String, Serializable > terminatedPairMap() :{  Map < String, Serializable > map;}{  map = pairMap() (";")?  {    return map;  }}public Map < String, Predicate > predicateMap() :{  Map < String, Predicate > map = Collections.synchronizedMap  (    new HashMap < String, Predicate > ()  )  ;}{  (    keyPredicate(map)    (      < COMMA > keyPredicate(map)    )*  )  {    return map;  }}public Map < String, Predicate > terminatedPredicateMap() :{  Map < String, Predicate > map;}{  map = predicateMap() (";")?  {    return map;  }}public CompositeNode subComposite(Map < String, Subscription > map) :{  Map < String, Predicate > pmap;  CompositeNode node;}{  (    LOOKAHEAD(2)    < OPEN_CPAR > pmap = predicateMap() < CLOSE_CPAR >    {      Subscription sub = new Subscription();      sub.setPredicateMap(pmap);      String key = "s" + (map.size() + 1);      node = new CompositeNode();      node.content = key;      map.put(key, sub);      return node;    }  | node = composite(map)    {      return node;    }  )}public CompositeNode composite(Map < String, Subscription > map) :{  CompositeNode lnode;  CompositeNode rnode;  Token o;}{  (    < OPEN_CPAR > lnode = subComposite(map)    (      o = < LOPERATOR > rnode = subComposite(map)    )    < CLOSE_CPAR >  )  {    CompositeNode node = new CompositeNode();    node.leftNode = lnode;    lnode.setParentNode(node);    node.rightNode = rnode;    rnode.setParentNode(node);    node.content = o.toString();    return node;  }}public CompositeSubscription compositeSubscription() :{  //getAtomicSubscription
  Map < String, Subscription > map = new HashMap < String, Subscription > ();  CompositeSubscription cs = new CompositeSubscription();  CompositeNode node;  Token i;}{  (    i = < IDENTIFIER > node = composite(map)  )  {    if (!(i.toString().equals("cs"))) throw new ParseException("Not a composite subscription.");    cs.setRoot(node);    cs.setSubscriptionMap(map);    cs.setAtomicSubscriptionNumber(map.size());    return cs;  }}public Unsubscription unsubscription() :{  Unsubscription usub = new Unsubscription();  Token i;  Token id;}{  i = < IDENTIFIER > id = < IDENTIFIER > (";")  {    if (!(i.toString().equals("us") || i.toString().equals("unsubscribe"))) throw new ParseException("Not an unsubscription.");    usub.setSubID(id.image);    return usub;  }}/**
 * Not Implemented
 */public Uncompositesubscription uncompositeSubscription() :{  Uncompositesubscription ucs = new Uncompositesubscription();}{  {    ucs.setSubID("");    return ucs;  }}/**
 * Not Implemented
 */public Unadvertisement unadvertisement() :{  Unadvertisement uadv = new Unadvertisement();}{  {    uadv.setAdvID("");    return uadv;  }}
