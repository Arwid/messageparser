 /**
 * JavaCC file for XMLMessageParser
 *
 * @author Arwid Bancewicz
 */options{ /* JDK_VERSION = "1.4"; */}PARSER_BEGIN(XMLMessageParser)package messageparser.common.message.parser.xml;import java.util.HashMap;import java.io.Serializable;import java.util.HashMap;import java.util.Map;import messageparser.common.message.CompositeSubscriptionOPs;import messageparser.common.message.Predicate;import messageparser.common.message.Advertisement;import messageparser.common.message.Subscription;import messageparser.common.message.Publication;import messageparser.common.message.CompositeSubscription;import messageparser.common.message.CompositeNode;import messageparser.common.message.parser.UniversalMessageParser;public class XMLMessageParser extends UniversalMessageParser{  public XMLMessageParser()  {}  private XMLMessageParser getParser(String stringRep)  {    java.io.StringReader sr = new java.io.StringReader(stringRep);    java.io.Reader r = new java.io.BufferedReader(sr);    XMLMessageParser parser = new XMLMessageParser(r);    return parser;  }  public Publication parsePublication(String stringRep) throws ParseException  {    java.io.StringReader sr = new java.io.StringReader(stringRep);    java.io.Reader r = new java.io.BufferedReader(sr);    XMLMessageParser parser = new XMLMessageParser(r);    Publication o = parser.publication();    return o;  }  public Advertisement parseAdvertisement(String stringRep) throws ParseException  {    java.io.StringReader sr = new java.io.StringReader(stringRep);    java.io.Reader r = new java.io.BufferedReader(sr);    XMLMessageParser parser = new XMLMessageParser(r);    Advertisement o = parser.advertisement();    return o;  }  public Subscription parseSubscription(String stringRep) throws ParseException  {    java.io.StringReader sr = new java.io.StringReader(stringRep);    java.io.Reader r = new java.io.BufferedReader(sr);    XMLMessageParser parser = new XMLMessageParser(r);    Subscription o = parser.subscription();    return o;  }  @ Override public CompositeSubscription parseCompositeSubscription(String stringRep) throws ParseException  {    CompositeSubscription o = getParser(stringRep).compositeSubscription();    return o;  }  public Map < String, Serializable > parsePairMap(String stringRep) throws ParseException  {    java.io.StringReader sr = new java.io.StringReader(stringRep);    java.io.Reader r = new java.io.BufferedReader(sr);    XMLMessageParser parser = new XMLMessageParser(r);    Map < String, Serializable > o = parser.pairMap();    return o;  }  public Map < String, Predicate > parsePredicateMap(String stringRep) throws ParseException  {    java.io.StringReader sr = new java.io.StringReader(stringRep);    java.io.Reader r = new java.io.BufferedReader(sr);    XMLMessageParser parser = new XMLMessageParser(r);    Map < String, Predicate > o = parser.predicateMap();    return o;  }  public String printPairMap(Map < String, Serializable > pairMap)  {    String stringRep = "";    stringRep += "<predicates>";    stringRep += "<predicate name=\"class\" value=\"" + pairMap.get("class") + "\"/>";    synchronized (pairMap)    {      for (String attribute : pairMap.keySet())      {        if (attribute == null) break;        if (attribute.equalsIgnoreCase("class")) continue;        Object value = pairMap.get(attribute);        stringRep += "<predicate name=\"" + attribute + "\" ";        stringRep += "value=\"" + value + "\"/>";      }    }    stringRep += "</predicates>";    return stringRep;  }  public String printPredicateMap(Map < String, Predicate > predicateMap)  {    String stringRep = "";    stringRep += "<predicates>";    stringRep += "<predicate name=\"class\" op=\"eq\" value=\"" + predicateMap.get("class").getValue() + "\"/>";    synchronized (predicateMap)    {      for (String attribute : predicateMap.keySet())      {        if (attribute.equalsIgnoreCase("class")) continue;        Predicate p = predicateMap.get(attribute);        stringRep += "<predicate name=\"" + attribute + "\" ";        stringRep += "op=\"" + p.getOp() + "\" ";        stringRep += "value=\"" + p.getValue() + "\"/>";      }    }    stringRep += "</predicates>";    return stringRep;  }  public String printCompositeNodes(CompositeNode root, Map < String, Subscription > subMap)  {    String rootToString = "";    if (root.content.equals(CompositeSubscriptionOPs.COMPOSIT_SUBSCRIPTION_AND) || root.content.equals(CompositeSubscriptionOPs.COMPOSIT_SUBSCRIPTION_OR))    {      rootToString = printCompositeNodes(root.leftNode, subMap) + "<csubscription op=\"" + root.content + "\">" + printCompositeNodes(root.rightNode, subMap) + "<csubscription/>";    }    else    {      Subscription sub = subMap.get(root.content);      rootToString = printPredicateMap(sub.getPredicateMap());    }    return rootToString;  }  public String print(Object obj)  {    String ret = "";    if (obj instanceof Publication)    {      ret += "<publish>";      Publication pub = (Publication) obj;      ret += printPairMap(pub.getPairMap());      ret += "<timestamp>" + pub.getTimeStamp() + "</timestamp>";      ret += "</publish>";    }    else if (obj instanceof Advertisement)    {      ret += "<advertise>";      Advertisement adv = (Advertisement) obj;      ret += printPredicateMap(adv.getPredicateMap());      ret += "</advertise>";    }    else if (obj instanceof Subscription)    {      ret += "<subsribe>";      Subscription sub = (Subscription) obj;      ret += printPredicateMap(sub.getPredicateMap());      ret += "</subsribe>";    }    else if (obj instanceof CompositeSubscription)    {      ret += "<csubsribe>";      CompositeSubscription sub = (CompositeSubscription) obj;      ret += printCompositeNodes(sub.getRoot(), sub.getSubscriptionMap());      ret += "</csubsribe>";    }    ret += "";    return ret;  }  /* Main method for testing */  public static void main(String args [])  {    XMLMessageParser parser = new XMLMessageParser();    while (true)    {      try      {        java.io.BufferedReader r = new java.io.BufferedReader(new java.io.InputStreamReader(System.in));        String str = r.readLine();        Object o = parser.parse(str);        System.err.println("JAVA OBJECT: " + o);      }      catch (Exception err)      {        err.printStackTrace();      }    }  }}PARSER_END(XMLMessageParser)SKIP :{  " "| "\t"| "\n"| "\r"}TOKEN :{  < #SOPERATOR :    "eq"  | "str-le"  | "str-lt"  | "str-gt"  | "str-ge"  | "str-prefix"  | "str-postfix"  | "str-contains"  | "neq" >| < #NOPERATOR :    "="  | "<"  | ">"  | "<="  | ">="  | "<>" >| < #LOPERATOR :    "&"  | "||" >| < #COPERATOR : "isPresent" >| < QUOTED_SOPERATOR : "\"" < SOPERATOR > "\"" >| < QUOTED_NOPERATOR : "\"" < NOPERATOR > "\"" >| < QUOTED_LOPERATOR : "\"" < LOPERATOR > "\"" >| < QUOTED_COPERATOR : "\"" < COPERATOR > "\"" >}TOKEN :{  < #LETTER : [ "_", "a"-"z", "A"-"Z" ] >| < #DIGIT : [ "0"-"9" ] >| < #SIGN : [ "-", "+" ] >| < #EXPONENT :    (      "E"    | "e"    )    (< SIGN >)? (< DIGIT >)+ >| < FLOATING_NUMBER :    "\"" (< SIGN >)? (< DIGIT >)* "." (< DIGIT >)* (< EXPONENT >)?  | (< DIGIT >)+ (< EXPONENT >) "\"" >| < INT_NUMBER : "\"" (< SIGN >)? (< DIGIT >)+ "\"" >| < IDENTIFIER :    "\"" < LETTER >    (      < LETTER >    | < DIGIT >    | "-"    )*    "\"" >| < #ESCAPE_CHAR : "\\" [ "n", "t", "b", "r", "f", "\\", "'", "\"" ] >| < DOUBLE_QUOTE_LITERAL :    "\""    (      (~[ "\"", "\\", "\n", "\r" ])    | < ESCAPE_CHAR >    )+    "\"" >| < EMPTY_QUOTE_LITERAL :    "\'\'"  | "\"\"" >| < COMMA : "," >| < OPEN_CPAR : "{" >| < CLOSE_CPAR : "}" >| < OPEN_PAR : "[" >| < CLOSE_PAR : "]" >| < COLON : ":" >| < SEMI_COLON : ";" >| < QUOTE : "\"" >| < OPEN_TAGL : "<" >| < TAGR : ">" >| < CLOSE_TAGL : "</" >| < CLOSE_EMPTY_TAG : "/>" >}public Publication publication() :{  Map < String, Serializable > map;  Publication p = new Publication();  Token i;}{  (    < OPEN_TAGL > "publish" < TAGR > map = pairMap() < CLOSE_TAGL > "publish" < TAGR >  )  {    //String c = unescape(i.toString());
    //if (!(c.equals("p") || c.equals("publish")))
    //	throw new ParseException("Not a publication.");
    p.setPairMap(map);    return p;  }}public Advertisement advertisement() :{  Map < String, Predicate > map;  Advertisement a = new Advertisement();}{  (    < OPEN_TAGL > "advertise" < TAGR > map = predicateMap() < CLOSE_TAGL > "advertise" < TAGR >    // |
    // < OPEN_TAGL > "avertisement" < TAGR > map = predicateMap() < CLOSE_TAGL > "advertisement" < TAGR >
  )  {    a.setPredicateMap(map);    return a;  }}public Subscription subscription() :{  Map < String, Predicate > map;  Subscription s = new Subscription();  Token i;}{  (    < OPEN_TAGL > "subscription" < TAGR > map = predicateMap() < CLOSE_TAGL > "subscription" < TAGR >    // < OPEN_CPAR > i = < IDENTIFIER > < COLON > < OPEN_PAR > map = predicateMap() < CLOSE_PAR > < CLOSE_CPAR >
  )  {    s.setPredicateMap(map);    return s;  }}public CompositeSubscription compositeSubscription() :{  //getAtomicSubscription
  Map < String, Subscription > map = new HashMap < String, Subscription > ();  CompositeSubscription cs = new CompositeSubscription();  CompositeNode node;}{  (    < OPEN_TAGL > "csubscription" < TAGR > node = composite(map) < CLOSE_TAGL > "csubscription" < TAGR >  )  {    cs.setRoot(node);    cs.setSubscriptionMap(map);    cs.setAtomicSubscriptionNumber(map.size());    return cs;  }}public String string() :{  Token t;}{  (    t = < DOUBLE_QUOTE_LITERAL >    {      return unescape(t.image);    }  | t = < IDENTIFIER >    {      return unescape(t.toString());    }  )}public Serializable number() :{  Token t;}{  (    t = < FLOATING_NUMBER >    {      return new Double(unescape(t.image));    }  | t = < INT_NUMBER >    {      return new Long(unescape(t.image));    }  )}public Serializable object() :{  Serializable o;}{  (    o = number()    {      return o;    }  | o = string()    {      return o;    }  )}public void keyValue(Map < String, Serializable > map) :{  Token i;  Serializable v;}{  (    < OPEN_TAGL > "predicate" "name" "=" i = < IDENTIFIER > "value" "=" v = object() < CLOSE_EMPTY_TAG >  )  {    map.put(unescape(i.image), v);  }}public Predicate predicate() :{  Token o;  Serializable v = "";}{  "op" "="  (    o = < QUOTED_SOPERATOR > "value" "=" v = string()    {      return new Predicate(unescape(o.toString()), v);    }  | o = < QUOTED_NOPERATOR > "value" "=" v = number()    {      return new Predicate(unescape(o.toString()), v);    }  | o = < QUOTED_COPERATOR > "value" "="    (      v = string()    | v = number()    | < EMPTY_QUOTE_LITERAL >    )    {      return new Predicate(unescape(o.toString()), v);    }  )}public void keyPredicate(Map < String, Predicate > map) :{  Token k;  Predicate p;}{  (    < OPEN_TAGL > "predicate" "name" "=" k = < IDENTIFIER > p = predicate() < CLOSE_EMPTY_TAG >  )  {    map.put(unescape(k.image), p);  }}public Map < String, Serializable > pairMap() :{  Map < String, Serializable > map = new HashMap < String, Serializable > ();}{  < OPEN_TAGL > "predicates" < TAGR >  (    keyValue(map)    (      keyValue(map)    )*  )  < CLOSE_TAGL > "predicates" < TAGR >  {    return map;  }}public Map < String, Serializable > terminatedPairMap() :{  Map < String, Serializable > map;}{  map = pairMap() (";")  {    return map;  }}public Map < String, Predicate > predicateMap() :{  Map < String, Predicate > map = new HashMap < String, Predicate > ();}{  < OPEN_TAGL > "predicates" < TAGR >  (    keyPredicate(map)    (      keyPredicate(map)    )*  )  < CLOSE_TAGL > "predicates" < TAGR >  {    return map;  }}public Map < String, Predicate > terminatedPredicateMap() :{  Map < String, Predicate > map;}{  map = predicateMap() (";")  {    return map;  }}public CompositeNode subComposite(Map < String, Subscription > map) :{  Map < String, Predicate > pmap;  CompositeNode node;}{  (    //LOOKAHEAD(2)
    pmap = predicateMap()    {      Subscription sub = new Subscription();      sub.setPredicateMap(pmap);      String key = "s" + (map.size() + 1);      node = new CompositeNode();      node.content = key;      map.put(key, sub);      return node;    } /*
    |
    node = composite( map )
    {
      return node;
    }*/  )}public CompositeNode composite(Map < String, Subscription > map) :{  CompositeNode lnode;  CompositeNode rnode;  Token o;}{  (    lnode = subComposite(map)    (      < OPEN_TAGL > "csubscription" "op" "=" o = < QUOTED_LOPERATOR > < TAGR > rnode = subComposite(map) < CLOSE_TAGL > "csubscription" < TAGR >    )  )  {    CompositeNode node = new CompositeNode();    node.leftNode = lnode;    lnode.setParentNode(node);    node.rightNode = rnode;    rnode.setParentNode(node);    node.content = unescape(o.toString());    return node;  }}
